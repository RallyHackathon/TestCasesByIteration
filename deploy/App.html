<!DOCTYPE html>
<html>
<head>
    <title>Test-Status-by-Iteration</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",testCaseRecords:[],gridMargins:"10 5 10 5",launch:function(){var app=this;this.add(this._buildSummaryGridConfig()),this.add({xtype:"rallygrid",itemId:"testsFailedGrid",title:"<B>Tests Failed</B>",emptyText:"No Failed Test Cases",storeConfig:{model:"TestCase",autoLoad:!1},columnCfgs:["FormattedID","Name",{text:"Tester",dataIndex:"Owner"}],margin:this.gridMargins,showPagingToolbar:!1}),this.add({xtype:"rallygrid",itemId:"testsBlockedGrid",title:"<B>Tests Blocked</B>",emptyText:"No Blocked Test Cases",storeConfig:{model:"TestCase",autoLoad:!1},columnCfgs:["FormattedID","Name",{text:"Tester",dataIndex:"Owner"}],margin:this.gridMargins,showPagingToolbar:!1}),this.add({xtype:"rallygrid",itemId:"testsNotRunGrid",title:"<B>Tests Not Run</B>",emptyText:"No Test Cases that have not been run",storeConfig:{model:"TestCase",autoLoad:!1},columnCfgs:["FormattedID","Name",{text:"Tester",dataIndex:"Owner"}],margin:this.gridMargins,showPagingToolbar:!1}),this.add({xtype:"rallygrid",itemId:"testsPassedGrid",title:"<B>Tests Passed</B>",emptyText:"No Passing Test Cases",storeConfig:{model:"TestCase",autoLoad:!1},columnCfgs:["FormattedID","Name",{text:"Tester",dataIndex:"Owner"}],margin:this.gridMargins,showPagingToolbar:!1}),this.add(this.testStatusSummary);var currentProjectRef=Rally.util.Ref.getRelativeUri(Rally.environment.getContext().getScope().project._ref);this._getTestResultData(currentProjectRef)},_getTestResultData:function(projectRef){this.testCaseResultStore=Ext.create("Rally.data.WsapiDataStore",{model:"TestCase",autoLoad:!0,storeId:"TestResultStorer",context:{project:null},filters:this._getTestCaseFilters(projectRef),fetch:["Name","FormattedID","WorkProduct","ScheduleState","Iteration","Date","LastVerdict","Owner","ObjectID","Project"],limit:200,listeners:{load:function(store,data,success){this._onTestResultsLoaded(store,data)},scope:this}})},_onTestResultsLoaded:function(store,recordsArray){this.testCaseRecords=recordsArray;var testCaseByIterationMap=this._groupResultsByIteration(this.testCaseRecords),testSummaryData={iterationSummary:_.values(testCaseByIterationMap)};this.down("#summaryGrid").getStore().loadRawData(testSummaryData)},_updateDetailStoresWithData:function(records){var testCasesByVerdictMap=_.reduce(records,function(testCasesByVerdict,testCase){var lastVerdict=testCase.get("LastVerdict")||"NotRun";return testCasesByVerdict[lastVerdict]||(testCasesByVerdict[lastVerdict]=[]),testCasesByVerdict[lastVerdict].push(testCase),testCasesByVerdict},{});this.down("#testsFailedGrid").getStore().loadData(testCasesByVerdictMap.Fail||[]),this.down("#testsNotRunGrid").getStore().loadData(testCasesByVerdictMap.NotRun||[]),this.down("#testsPassedGrid").getStore().loadData(testCasesByVerdictMap.Pass||[]),this.down("#testsBlockedGrid").getStore().loadData(testCasesByVerdictMap.Blocked||[])},_buildSummaryGridConfig:function(){var iterationSummaryModel=Ext.define("IterationSummary",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"},{name:"_ref",type:"string"},{name:"Pass",type:"number"},{name:"Fail",type:"number"},{name:"NotRun",type:"number"},{name:"Blocked",type:"number"}]}),testSummaryStore=Ext.create("Ext.data.JsonStore",{storeId:"TestSummaryStore",model:iterationSummaryModel,proxy:{type:"memory",reader:{type:"json",root:"iterationSummary",idProperty:"Name"}},autoScroll:!0});return{xtype:"grid",itemId:"summaryGrid",title:"<B>Iteration Summary</B>",store:testSummaryStore,emptyText:"No In-Progress test cases for this project",columnLines:!1,margin:this.gridMargins,columns:{items:[{text:"Name",dataIndex:"Name"},{text:"Failed",dataIndex:"Fail"},{text:"Blocked",dataIndex:"Blocked"},{text:"Not Run",dataIndex:"NotRun"},{text:"Passed",dataIndex:"Pass"}],defaults:{flex:1}},listeners:{cellclick:this._onIterationClicked,scope:this},enableEditing:!0}},_onIterationClicked:function(grid,td,cellIndex,record,tr,rowIndex,e,eOpts){this._updateDetailStoresWithData(this.iterationTestCaseMap[record.get("_ref")])},_updateTestResultData:function(projectRef){var store=this.testCaseResultStore;this.testCaseRecords=[],store.clearFilter(!0),store.filter(this._getTestCaseFilters(projectRef))},_getTestCaseFilters:function(projectRef){return[{property:"Project",operator:"=",value:projectRef},{property:"WorkProduct",operator:"!=",value:null}]},_groupResultsByIteration:function(testCaseRecords){return this.iterationTestCaseMap={},_.reduce(testCaseRecords,function(results,testCase){if(testCase.get("WorkProduct")&&testCase.get("WorkProduct").ScheduleState&&"In-Progress"===testCase.get("WorkProduct").ScheduleState&&testCase.get("WorkProduct").Iteration){var iterationData=testCase.get("WorkProduct").Iteration,iterationId=iterationData._ref;this.iterationTestCaseMap[iterationId]||(this.iterationTestCaseMap[iterationId]=[]),this.iterationTestCaseMap[iterationId].push(testCase),results[iterationId]||(results[iterationId]=iterationData),this._updateIterationVerdictCounts(testCase,results[iterationId])}return results},{},this)},_updateIterationVerdictCounts:function(testCase,iterationData){var lastVerdict=testCase.get("LastVerdict")||"NotRun";iterationData[lastVerdict]||(iterationData[lastVerdict]=0),iterationData[lastVerdict]+=1}});

            Rally.launchApp('CustomApp', {
                name:"Test-Status-by-Iteration",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app{background-color:gray}.x-column-header{background-color:white}
    </style>
</head>
<body>
</body>
</html>
