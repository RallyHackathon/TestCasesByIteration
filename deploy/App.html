<!DOCTYPE html>
<html>
<head>
    <title>Test-Status-by-Iteration</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",testCaseRecords:[],launch:function(){var app=this,toolbar=Ext.create("Ext.panel.Panel",{items:[{xtype:"rallyprojectcombobox",itemId:"projectCombo",width:500,fieldLabel:"Project",value:Rally.util.Ref.getRelativeUri(Rally.environment.getContext().getScope().project._ref),listeners:{select:function(combo,records){this._updateTestResultData(records[0].get("_ref"))},scope:app}}]});this.add(toolbar);var summaryGridConfig=this._buildSummaryGridConfig();this.testStatusSummary=Ext.create("Ext.panel.Panel",{items:[summaryGridConfig,{xtype:"rallygrid",itemId:"testsFailedGrid",title:"<B>Tests Failed</B>",emptyText:"No Failed Test Cases",storeConfig:{model:"TestCase",autoLoad:!1},columnCfgs:["FormattedID","Name",{text:"Tester",dataIndex:"Owner"}]},{xtype:"rallygrid",itemId:"testsNotRunGrid",title:"<B>Tests Not Run</B>",emptyText:"No Test Cases that have not been run",storeConfig:{model:"TestCase",autoLoad:!1},columnCfgs:["FormattedID","Name",{text:"Tester",dataIndex:"Owner"}]},{xtype:"rallygrid",itemId:"testsPassedGrid",title:"<B>Tests Passed</B>",emptyText:"No Passing Test Cases",storeConfig:{model:"TestCase",autoLoad:!1},columnCfgs:["FormattedID","Name",{text:"Tester",dataIndex:"Owner"}]}]}),this.add(this.testStatusSummary),this._getTestResultData(toolbar.down("#projectCombo").getValue())},_getTestResultData:function(projectRef){this.testCaseResultStore=Ext.create("Rally.data.WsapiDataStore",{model:"TestCase",autoLoad:!0,storeId:"TestResultStorer",context:{project:null},filters:this._getTestCaseFilters(projectRef),fetch:["Name","FormattedID","WorkProduct","ScheduleState","Iteration","Date","LastVerdict","Owner","ObjectID","Project"],limit:200,listeners:{load:function(store,data,success){this._onTestResultsLoaded(store,data)},scope:this}})},_onTestResultsLoaded:function(store,recordsArray){this.testCaseRecords=recordsArray;var testCaseByIterationMap=this._groupResultsByIteration(this.testCaseRecords),testSummaryData={iterationSummary:_.values(testCaseByIterationMap)};this._updateSummaryStoreWithData(testSummaryData),this._updateDetailStoresWithData(this.testCaseRecords)},_updateSummaryStoreWithData:function(testSummaryData){this.down("#summaryGrid").getStore().loadRawData(testSummaryData)},_updateDetailStoresWithData:function(records){var testCasesByVerdictMap=_.reduce(records,function(testCasesByVerdict,testCase){var lastVerdict=testCase.get("LastVerdict")||"NotRun";return testCasesByVerdict[lastVerdict]||(testCasesByVerdict[lastVerdict]=[]),testCasesByVerdict[lastVerdict].push(testCase),testCasesByVerdict},{});this.down("#testsFailedGrid").getStore().loadData(testCasesByVerdictMap.Fail||[]),this.down("#testsNotRunGrid").getStore().loadData(testCasesByVerdictMap.NotRun||[]),this.down("#testsPassedGrid").getStore().loadData(testCasesByVerdictMap.Pass||[])},_buildSummaryGridConfig:function(){var iterationSummaryModel=Ext.define("IterationSummary",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"}]}),testSummaryStore=Ext.create("Ext.data.JsonStore",{storeId:"TestSummaryStore",model:iterationSummaryModel,proxy:{type:"memory",reader:{type:"json",root:"iterationSummary",idProperty:"Name"}},autoScroll:!0});return{xtype:"grid",itemId:"summaryGrid",title:"<B>Iteration Summary</B>",store:testSummaryStore,emptyText:"No In-Progress test cases for this project",columns:{items:[{text:"Name",dataIndex:"Name"}],defaults:{flex:1}},listeners:{cellclick:function(){console.log("cell clicked!")}},columnLines:!0,enableEditing:!0}},_updateTestResultData:function(projectRef){var store=this.testCaseResultStore;this.testCaseRecords=[],store.clearFilter(!0),store.filter(this._getTestCaseFilters(projectRef))},_getTestCaseFilters:function(projectRef){return[{property:"Project",operator:"=",value:projectRef},{property:"WorkProduct",operator:"!=",value:null}]},_groupResultsByIteration:function(testCaseRecords){return this.iterationIdMap={},_.reduce(testCaseRecords,function(results,testCase){if(testCase.get("WorkProduct")&&testCase.get("WorkProduct").ScheduleState&&"In-Progress"===testCase.get("WorkProduct").ScheduleState&&testCase.get("WorkProduct").Iteration){var iterationData=testCase.get("WorkProduct").Iteration,iterationId=iterationData._ref;this.iterationIdMap[iterationId]||(this.iterationIdMap[iterationId]=iterationData),results[iterationId]||(results[iterationId]=iterationData)}return results},{},this)}});

            Rally.launchApp('CustomApp', {
                name:"Test-Status-by-Iteration",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
